# FusionKit Home Agent 开发任务维护文档

> 来源设计文档：`docs/home-agent-feasibility.md`  
> 目标：将首页升级为支持“多目录 + 多文件 + 混合指定”的对话式 Agent 工作台，并可分步、可追踪地实施落地。

---

## 1. 使用说明（先读）

本文件用于日常执行管理，建议每次开发前后都更新：

1. 开始开发前，把一个任务标记为 `IN_PROGRESS`（同一时间只保留一个主任务进行中）。
2. 完成后改为 `DONE`，并填写“完成记录”和“验证记录”。
3. 遇到阻塞改为 `BLOCKED`，在“阻塞原因”填写明确原因与下一步方案。
4. 需求变更时，不删除原任务，改为 `CANCELLED` 并新增替代任务，保留历史。

---

## 2. 状态与优先级定义

### 2.1 任务状态

- `TODO`：未开始
- `IN_PROGRESS`：进行中
- `BLOCKED`：阻塞
- `DONE`：完成
- `CANCELLED`：取消（由新任务替代）

### 2.2 优先级

- `P0`：阻塞主链路，不完成无法推进
- `P1`：核心功能
- `P2`：增强与体验优化

---

## 3. 里程碑总览（建议顺序）

| 里程碑 | 名称 | 目标 | 预估 |
| --- | --- | --- | --- |
| M0 | 基线与任务模型 | 统一任务与目标集合数据结构 | 1 天 |
| M1 | 任务总线统一 | 转换/提取任务从页面状态迁移到 store | 2-3 天 |
| M2 | 目录发现与混合目标解析 | 支持多目录+多文件+排除规则 | 2-3 天 |
| M3 | Tool Registry 与执行适配 | 工具 Schema、校验、执行器打通 | 1-2 天 |
| M4 | 首页 Agent MVP | 对话、清单确认、入队执行 | 2-3 天 |
| M5 | 风险控制与可观测性 | 权限、审计、日志、错误处理 | 1-2 天 |
| M6 | 测试与发布准备 | 单测/集成/E2E、文档回填 | 1-2 天 |

---

## 4. 任务清单（主看板）

> 字段说明：  
> `依赖` 为空表示可立即做；`DoD` = Definition of Done（完成判定标准）。

| ID | 任务 | 优先级 | 依赖 | 状态 | 预计 |
| --- | --- | --- | --- | --- | --- |
| T-001 | 定义统一任务实体（`TaskKind/TaskLifecycle/TaskTargetRef`） | P0 | - | TODO | 0.5d |
| T-002 | 定义 `TargetSet` 与冲突优先级策略（排除/包含） | P0 | T-001 | TODO | 0.5d |
| T-003 | 新建 `useSubtitleConverterStore` 并迁移页面状态 | P0 | T-001 | TODO | 1d |
| T-004 | 新建 `useSubtitleExtractorStore` 并迁移页面状态 | P0 | T-001 | TODO | 1d |
| T-005 | 建立 `target-resolver`（多目录+多文件混合解析） | P0 | T-002 | TODO | 1d |
| T-006 | 建立 `discovery-engine`（扫描、去重、来源标记） | P0 | T-002 | TODO | 1d |
| T-007 | 建立 `filter-rules`（候选/排除双清单与原因） | P1 | T-006 | TODO | 1d |
| T-008 | 新增主进程 FS IPC（目录扫描/元数据读取） | P0 | T-006 | TODO | 1d |
| T-009 | 定义 Tool Registry + Zod schemas | P0 | T-001,T-002 | TODO | 1d |
| T-010 | 实现 `resolve_processing_targets` 工具 | P0 | T-005,T-009 | TODO | 0.5d |
| T-011 | 实现 `scan_subtitle_files_in_targets` 工具 | P0 | T-006,T-008,T-009 | TODO | 0.5d |
| T-012 | 实现 `build_processing_candidates` 工具 | P1 | T-007,T-009 | TODO | 0.5d |
| T-013 | 实现 `apply_candidate_filters` 工具 | P1 | T-007,T-009 | TODO | 0.5d |
| T-014 | 实现 3 个 queue 工具适配层（翻译/转换/提取） | P0 | T-003,T-004,T-009 | TODO | 1d |
| T-015 | 实现 `useAgentStore`（会话、计划、状态机） | P0 | T-009 | TODO | 1d |
| T-016 | 实现 `orchestrator`（解析->工具调用->回写） | P0 | T-010,T-011,T-012,T-013,T-014,T-015 | TODO | 1d |
| T-017 | 新建 `HomeAgent` 页面（对话区+候选清单+计划卡） | P0 | T-015,T-016 | TODO | 1.5d |
| T-018 | 首页路由替换与旧 Home 融合策略 | P1 | T-017 | TODO | 0.5d |
| T-019 | 清单二次筛选交互（增删目录/文件/限制条数） | P1 | T-017 | TODO | 1d |
| T-020 | 执行模式支持（草案/确认即执行/自动执行） | P1 | T-016,T-017 | TODO | 0.5d |
| T-021 | 权限白名单与敏感目录二次确认 | P0 | T-008,T-016 | TODO | 0.5d |
| T-022 | 结构化日志与审计记录（扫描、筛选、入队） | P1 | T-016 | TODO | 0.5d |
| T-023 | 单元测试（resolver/filter/schema） | P0 | T-005,T-007,T-009 | TODO | 1d |
| T-024 | 集成测试（混合目标指令全链路） | P1 | T-016,T-019,T-020 | TODO | 1d |
| T-025 | E2E 测试（多目录+多文件+排除规则） | P1 | T-017,T-019,T-020 | TODO | 1d |
| T-026 | 文档回填（设计偏差、最终接口、使用说明） | P2 | T-025 | TODO | 0.5d |

---

## 5. 分阶段执行清单（可勾选）

## M0：基线与任务模型

- [ ] T-001 统一任务模型类型定义完成
- [ ] T-002 `TargetSet` 与冲突策略文档化并落地类型
- [ ] 产出：`src/agent/types.ts`（或同类文件） + 设计注释

### M0 DoD

- 类型可覆盖“多目录 + 多文件 + 混合 + 排除”
- 冲突优先级有明确默认策略并可配置

## M1：任务总线统一

- [ ] T-003 转换任务迁移到 store
- [ ] T-004 提取任务迁移到 store
- [ ] 工具页仍可正常显示任务进度与状态

### M1 DoD

- 首页和工具页可共享同一任务源
- 无回归：转换/提取现有功能可用

## M2：目录发现与混合目标解析

- [ ] T-005 完成自然语言目标解析（目录/文件/排除）
- [ ] T-006 完成扫描引擎（递归、去重、来源）
- [ ] T-007 完成候选/排除双清单与原因
- [ ] T-008 完成 Main IPC 扫描能力

### M2 DoD

- 能输入“多个目录 + 多个文件 + 排除规则”并得到稳定清单
- 对歧义/冲突可追问且不盲猜

## M3：Tool Registry 与执行适配

- [ ] T-009 Zod schema + registry 完成
- [ ] T-010/T-011/T-012/T-013 discovery 系列工具完成
- [ ] T-014 queue 系列工具完成

### M3 DoD

- 所有工具入参都有 schema 校验
- 解析->扫描->筛选->入队链路可跑通

## M4：首页 Agent MVP

- [ ] T-015 Agent store 完成
- [ ] T-016 orchestrator 完成
- [ ] T-017 HomeAgent 页面完成
- [ ] T-018 路由替换完成
- [ ] T-019 二次筛选交互完成
- [ ] T-020 三种执行模式完成

### M4 DoD

- 用户可通过对话完成清单生成、编辑、确认并执行
- 执行后进度可回流展示

## M5：风险控制与可观测性

- [ ] T-021 权限白名单 + 敏感目录保护
- [ ] T-022 审计与日志完成

### M5 DoD

- 未授权路径不可访问
- 每轮关键动作可追踪（可定位问题）

## M6：测试与发布准备

- [ ] T-023 单元测试通过
- [ ] T-024 集成测试通过
- [ ] T-025 E2E 用例通过
- [ ] T-026 文档回填完成

### M6 DoD

- 核心路径测试通过且可复现
- 文档与实现一致

---

## 6. 每日推进模板（复制使用）

```md
### YYYY-MM-DD

- 今日主任务：T-xxx
- 结果：
  - 完成：
  - 未完成：
- 阻塞：
  - [ ] 是否需要拆分新任务
- 代码变更：
  - `path/a`
  - `path/b`
- 验证：
  - 单测：
  - 手测：
- 明日计划：
```

---

## 7. 任务详情模板（新增任务时使用）

```md
#### T-xxx 任务标题

- 优先级：P0/P1/P2
- 依赖：T-xxx, T-yyy
- 状态：TODO
- 目标：
- 变更范围（文件）：
- 风险点：
- DoD：
  - [ ]
  - [ ]
- 验证方式：
  - [ ] 单元测试
  - [ ] 集成测试
  - [ ] 手工验证
```

---

## 8. 风险前置检查（每个里程碑开始前）

- [ ] 本里程碑是否引入新的权限边界风险
- [ ] 是否需要新增追问文案避免误处理
- [ ] 是否存在兼容旧工具页面的回归风险
- [ ] 是否需要补充 i18n key（zh/en/ja）
- [ ] 是否需要新增 IPC 类型声明（`src/vite-env.d.ts`）

---

## 9. 当前执行建议（第一周）

建议优先顺序：

1. `T-001` -> `T-002`（先把模型打稳）
2. `T-003` + `T-004`（先统一任务总线）
3. `T-005` -> `T-006` -> `T-007` -> `T-008`（打通目录混合目标能力）

这样可以最快形成“可验证核心链路”，后续再接 `Tool Registry` 与 `HomeAgent UI`，返工风险最低。
